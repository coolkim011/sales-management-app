<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¶œ ê´€ë¦¬ ì•±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        .container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .card { background: white; border-radius: 20px; padding: 40px; max-width: 400px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; margin-bottom: 10px; }
        .group { margin-bottom: 20px; }
        .group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .group input { width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; }
        .group input:focus { outline: none; border-color: #3498db; }
        .btn { width: 100%; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; }
        
        .app { max-width: 100vw; min-height: 100vh; background: white; display: none; flex-direction: column; }
        .app-header { background: linear-gradient(45deg, #2c3e50, #34495e); color: white; padding: 20px; text-align: center; }
        .app-header h1 { font-size: 1.5em; margin-bottom: 5px; }
        .user-info { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; color: white; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        
        .tab-bar { display: flex; background: #f8f9fa; }
        .tab-btn { flex: 1; padding: 12px 8px; text-align: center; cursor: pointer; background: #f8f9fa; border: none; font-size: 11px; font-weight: 600; color: #495057; }
        .tab-btn.active { background: white; color: #2c3e50; border-bottom: 3px solid #3498db; }
        .content { flex: 1; padding: 15px; padding-bottom: 80px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 12px; border-radius: 12px; text-align: center; }
        .summary-card h3 { font-size: 0.75em; margin-bottom: 8px; }
        .summary-card .amount { font-size: 1.1em; font-weight: bold; }
        
        .form-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .form-card h3 { color: #2c3e50; margin-bottom: 20px; font-size: 1.1em; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        
        .table-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: linear-gradient(45deg, #34495e, #2c3e50); color: white; padding: 10px 6px; text-align: left; font-size: 11px; }
        td { padding: 8px 6px; border-bottom: 1px solid #e9ecef; font-size: 11px; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .empty-state { text-align: center; padding: 30px 20px; color: #6c757d; font-size: 14px; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e9ecef; padding: 10px; }
        .nav-btn { width: 100%; background: linear-gradient(45deg, #27ae60, #229954); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; }
        
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen" class="container">
        <div class="card">
            <div class="header">
                <h1>ğŸ’° ë§¤ì¶œ ê´€ë¦¬</h1>
                <p>í˜„ê¸ˆë§¤ì¶œê³¼ ì‚¬ì—…ìë§¤ì¶œì„ ì‰½ê²Œ ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>
            
            <div class="group">
                <label>ì‚¬ìš©ì ì´ë¦„</label>
                <input type="text" id="username" value="admin">
            </div>
            <div class="group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" value="1234">
            </div>
            <button class="btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
            <p style="text-align: center; margin-top: 15px; color: #6c757d; font-size: 12px;">
                ë°ëª¨: admin / 1234
            </p>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± í™”ë©´ -->
    <div id="app-screen" class="app">
        <div class="app-header">
            <div class="user-info">
                <span id="current-user">ì‚¬ìš©ì</span>
                <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <h1>ğŸ’° ë§¤ì¶œ ê´€ë¦¬</h1>
            <p>í˜„ê¸ˆë§¤ì¶œê³¼ ì‚¬ì—…ìë§¤ì¶œì„ ì‰½ê²Œ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>
        
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchScreen('cash', this)">í˜„ê¸ˆë§¤ì¶œ</button>
            <button class="tab-btn" onclick="switchScreen('business', this)">ì‚¬ì—…ìë§¤ì¶œ</button>
            <button class="tab-btn" onclick="switchScreen('expense', this)">ì§€ì¶œê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchScreen('client', this)">ê±°ë˜ì²˜</button>
            <button class="tab-btn" onclick="switchScreen('stats', this)">í†µê³„</button>
        </div>
        
        <div class="content">
            <!-- í˜„ê¸ˆë§¤ì¶œ í™”ë©´ -->
            <div id="cash-screen" class="screen active">
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>í˜„ê¸ˆë§¤ì¶œ ì´ê³„</h3>
                        <div class="amount" id="cash-total">â‚©0</div>
                    </div>
                    <div class="summary-card">
                        <h3>í˜„ê¸ˆë§¤ì¶œ ê±´ìˆ˜</h3>
                        <div class="amount" id="cash-count">0ê±´</div>
                    </div>
                </div>
                
                <div class="form-card">
                    <h3>ğŸ“ í˜„ê¸ˆë§¤ì¶œ ë“±ë¡</h3>
                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="cash-date">
                    </div>
                    <div class="form-group">
                        <label>ê³ ê°ëª…</label>
                        <input type="text" id="cash-customer" placeholder="ê³ ê°ëª… ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ìƒí’ˆ/ì„œë¹„ìŠ¤</label>
                        <input type="text" id="cash-product" placeholder="ìƒí’ˆ/ì„œë¹„ìŠ¤ëª…">
                    </div>
                    <div class="form-group">
                        <label>ë§¤ì¶œê¸ˆì•¡</label>
                        <input type="number" id="cash-amount" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ë§¤ì¶œ ë£¨íŠ¸</label>
                        <select id="cash-route">
                            <option value="">ë§¤ì¶œ ë£¨íŠ¸ ì„ íƒ</option>
                            <option value="í˜„ì¥íŒë§¤">í˜„ì¥íŒë§¤</option>
                            <option value="ì˜¨ë¼ì¸">ì˜¨ë¼ì¸</option>
                            <option value="ì§€ì¸ì¶”ì²œ">ì§€ì¸ì¶”ì²œ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ë¹„ê³ </label>
                        <textarea id="cash-memo" placeholder="ì¶”ê°€ ì •ë³´"></textarea>
                    </div>
                    <button class="btn" onclick="addCashSale()">í˜„ê¸ˆë§¤ì¶œ ì¶”ê°€</button>
                </div>
                
                <div class="table-card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ë‚ ì§œ</th>
                                    <th>ê³ ê°ëª…</th>
                                    <th>ìƒí’ˆ/ì„œë¹„ìŠ¤</th>
                                    <th>ê¸ˆì•¡</th>
                                    <th>ë§¤ì¶œë£¨íŠ¸</th>
                                    <th>ë¹„ê³ </th>
                                    <th>ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="cash-table">
                                <tr><td colspan="7" class="empty-state">ë“±ë¡ëœ í˜„ê¸ˆë§¤ì¶œì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ì‚¬ì—…ìë§¤ì¶œ í™”ë©´ -->
            <div id="business-screen" class="screen">
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>ì‚¬ì—…ìë§¤ì¶œ ì´ê³„</h3>
                        <div class="amount" id="business-total">â‚©0</div>
                    </div>
                    <div class="summary-card">
                        <h3>ì‚¬ì—…ìë§¤ì¶œ ê±´ìˆ˜</h3>
                        <div class="amount" id="business-count">0ê±´</div>
                    </div>
                </div>
                
                <div class="form-card">
                    <h3>ğŸ¢ ì‚¬ì—…ìë§¤ì¶œ ë“±ë¡</h3>
                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="business-date">
                    </div>
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜ëª…</label>
                        <input type="text" id="business-client" placeholder="ê±°ë˜ì²˜ëª… ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ìƒí’ˆ/ì„œë¹„ìŠ¤</label>
                        <input type="text" id="business-product" placeholder="ìƒí’ˆ/ì„œë¹„ìŠ¤ëª…">
                    </div>
                    <div class="form-group">
                        <label>ë§¤ì¶œê¸ˆì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</label>
                        <input type="number" id="business-amount" placeholder="ê¸ˆì•¡ ì…ë ¥" oninput="calculateTax()">
                    </div>
                    <div class="form-group">
                        <label>ë¶€ê°€ì„¸</label>
                        <input type="number" id="business-tax" readonly>
                    </div>
                    <div class="form-group">
                        <label>ë¹„ê³ </label>
                        <textarea id="business-memo" placeholder="ì¶”ê°€ ì •ë³´"></textarea>
                    </div>
                    <button class="btn" onclick="addBusinessSale()">ì‚¬ì—…ìë§¤ì¶œ ì¶”ê°€</button>
                </div>
                
                <div class="table-card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ë‚ ì§œ</th>
                                    <th>ê±°ë˜ì²˜ëª…</th>
                                    <th>ìƒí’ˆ/ì„œë¹„ìŠ¤</th>
                                    <th>ê³µê¸‰ê°€ì•¡</th>
                                    <th>ë¶€ê°€ì„¸</th>
                                    <th>ì´ê¸ˆì•¡</th>
                                    <th>ë¹„ê³ </th>
                                    <th>ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="business-table">
                                <tr><td colspan="8" class="empty-state">ë“±ë¡ëœ ì‚¬ì—…ìë§¤ì¶œì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ì§€ì¶œê´€ë¦¬ í™”ë©´ -->
            <div id="expense-screen" class="screen">
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>ì´ ì§€ì¶œì•¡</h3>
                        <div class="amount" id="expense-total">â‚©0</div>
                    </div>
                    <div class="summary-card">
                        <h3>ì§€ì¶œ ê±´ìˆ˜</h3>
                        <div class="amount" id="expense-count">0ê±´</div>
                    </div>
                </div>
                
                <div class="form-card">
                    <h3>ğŸ’¸ ì§€ì¶œ ë“±ë¡</h3>
                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="expense-date">
                    </div>
                    <div class="form-group">
                        <label>ì§€ì¶œì²˜</label>
                        <input type="text" id="expense-vendor" placeholder="ì§€ì¶œì²˜ëª… ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ì§€ì¶œí•­ëª©</label>
                        <select id="expense-category">
                            <option value="">ì§€ì¶œí•­ëª© ì„ íƒ</option>
                            <option value="ì¬ë£Œë¹„">ì¬ë£Œë¹„</option>
                            <option value="ì„ëŒ€ë£Œ">ì„ëŒ€ë£Œ</option>
                            <option value="ì¸ê±´ë¹„">ì¸ê±´ë¹„</option>
                            <option value="ê´‘ê³ í™ë³´ë¹„">ê´‘ê³ í™ë³´ë¹„</option>
                            <option value="í†µì‹ ë¹„">í†µì‹ ë¹„</option>
                            <option value="ìš´ì†¡ë¹„">ìš´ì†¡ë¹„</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì§€ì¶œê¸ˆì•¡</label>
                        <input type="number" id="expense-amount" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ë¹„ê³ </label>
                        <textarea id="expense-memo" placeholder="ì¶”ê°€ ì •ë³´"></textarea>
                    </div>
                    <button class="btn" onclick="addExpense()">ì§€ì¶œ ì¶”ê°€</button>
                </div>
                
                <div class="table-card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ë‚ ì§œ</th>
                                    <th>ì§€ì¶œì²˜</th>
                                    <th>í•­ëª©</th>
                                    <th>ê¸ˆì•¡</th>
                                    <th>ë¹„ê³ </th>
                                    <th>ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="expense-table">
                                <tr><td colspan="6" class="empty-state">ë“±ë¡ëœ ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ê±°ë˜ì²˜ í™”ë©´ -->
            <div id="client-screen" class="screen">
                <div class="form-card">
                    <h3>ğŸ¢ ê±°ë˜ì²˜ ë“±ë¡</h3>
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜ëª…</label>
                        <input type="text" id="client-name" placeholder="ê±°ë˜ì²˜ëª… ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ì‚¬ì—…ìë²ˆí˜¸</label>
                        <input type="text" id="client-business-number" placeholder="ì‚¬ì—…ìë²ˆí˜¸ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ì—°ë½ì²˜</label>
                        <input type="text" id="client-contact" placeholder="ì—°ë½ì²˜ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ì£¼ì†Œ</label>
                        <input type="text" id="client-address" placeholder="ì£¼ì†Œ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label>ë¹„ê³ </label>
                        <textarea id="client-memo" placeholder="ì¶”ê°€ ì •ë³´"></textarea>
                    </div>
                    <button class="btn" onclick="addClient()">ê±°ë˜ì²˜ ì¶”ê°€</button>
                </div>
                
                <div class="table-card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ê±°ë˜ì²˜ëª…</th>
                                    <th>ì‚¬ì—…ìë²ˆí˜¸</th>
                                    <th>ì—°ë½ì²˜</th>
                                    <th>ì£¼ì†Œ</th>
                                    <th>ë¹„ê³ </th>
                                    <th>ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="client-table">
                                <tr><td colspan="6" class="empty-state">ë“±ë¡ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- í†µê³„ í™”ë©´ -->
            <div id="stats-screen" class="screen">
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>ì´ ë§¤ì¶œì•¡</h3>
                        <div class="amount" id="total-sales">â‚©0</div>
                    </div>
                    <div class="summary-card">
                        <h3>ì´ ì§€ì¶œì•¡</h3>
                        <div class="amount" id="total-expenses">â‚©0</div>
                    </div>
                    <div class="summary-card">
                        <h3>ìˆœì´ìµ</h3>
                        <div class="amount" id="net-profit">â‚©0</div>
                    </div>
                    <div class="summary-card">
                        <h3>ì´ ê±°ë˜ ê±´ìˆ˜</h3>
                        <div class="amount" id="total-count">0ê±´</div>
                    </div>
                </div>

                <!-- ë§¤ì¶œ vs ì§€ì¶œ ì›í˜• ê·¸ë˜í”„ -->
                <div class="form-card">
                    <h3>ğŸ“Š ë§¤ì¶œ vs ì§€ì¶œ ë¹„êµ</h3>
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <canvas id="sales-expense-chart" width="300" height="300"></canvas>
                    </div>
                </div>

                <!-- ì „ë‹¬ vs ì´ë²ˆë‹¬ ë¹„êµ -->
                <div class="form-card">
                    <h3>ğŸ“ˆ ì „ë‹¬ vs ì´ë²ˆë‹¬ ë¹„êµ</h3>
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <canvas id="monthly-comparison-chart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- ì›”ë³„ ë¶€ê°€ì„¸ í•©ê³„ -->
                <div class="form-card">
                    <h3>ğŸ’° ì›”ë³„ ë¶€ê°€ì„¸ í˜„í™©</h3>
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <canvas id="monthly-tax-chart" width="400" height="200"></canvas>
                    </div>
                    <div id="monthly-tax-summary" style="margin-top: 15px; font-size: 14px;"></div>
                </div>
                
                <div class="form-card">
                    <h3>ğŸ“Š ë§¤ì¶œ ë£¨íŠ¸ë³„ í˜„í™©</h3>
                    <div id="route-stats">ë°ì´í„°ë¥¼ ë“±ë¡í•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>
                
                <div class="form-card">
                    <h3>ğŸ’¸ ì§€ì¶œ í•­ëª©ë³„ í˜„í™©</h3>
                    <div id="expense-stats">ë°ì´í„°ë¥¼ ë“±ë¡í•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>
            </div>
        </div>
        
        <div class="bottom-nav">
            <button class="nav-btn" onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let cashSales = [];
        let businessSales = [];
        let expenses = [];
        let clients = [];
        let currentUser = null;

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // ë¡œê·¸ì¸
        function doLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (username === 'admin' && password === '1234') {
                currentUser = username;
                document.getElementById('current-user').textContent = username;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'flex';
                init();
                showNotification(username + 'ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!', 'success');
            } else {
                showNotification('ì‚¬ìš©ìëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function doLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                currentUser = null;
                document.getElementById('app-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }

        // í™”ë©´ ì „í™˜
        function switchScreen(screen, button) {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(screen + '-screen').classList.add('active');
            
            if (screen === 'stats') {
                setTimeout(() => {
                    drawSalesExpenseChart();
                    drawMonthlyComparisonChart();
                    drawMonthlyTaxChart();
                }, 100);
            }
        }

        // ì´ˆê¸°í™”
        function init() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cash-date').value = today;
            document.getElementById('business-date').value = today;
            document.getElementById('expense-date').value = today;
            
            loadData();
            updateTables();
            updateSummaries();
        }

        // ë°ì´í„° ë¡œë“œ/ì €ì¥
        function loadData() {
            if (!currentUser) return;
            const prefix = currentUser + '_';
            cashSales = JSON.parse(localStorage.getItem(prefix + 'cashSales') || '[]');
            businessSales = JSON.parse(localStorage.getItem(prefix + 'businessSales') || '[]');
            expenses = JSON.parse(localStorage.getItem(prefix + 'expenses') || '[]');
            clients = JSON.parse(localStorage.getItem(prefix + 'clients') || '[]');
        }

        function saveData() {
            if (!currentUser) return;
            const prefix = currentUser + '_';
            localStorage.setItem(prefix + 'cashSales', JSON.stringify(cashSales));
            localStorage.setItem(prefix + 'businessSales', JSON.stringify(businessSales));
            localStorage.setItem(prefix + 'expenses', JSON.stringify(expenses));
            localStorage.setItem(prefix + 'clients', JSON.stringify(clients));
        }

        // ë¶€ê°€ì„¸ ê³„ì‚°
        function calculateTax() {
            const total = parseInt(document.getElementById('business-amount').value) || 0;
            const tax = Math.round(total / 11);
            document.getElementById('business-tax').value = tax;
        }

        // í˜„ê¸ˆë§¤ì¶œ ì¶”ê°€
        function addCashSale() {
            const date = document.getElementById('cash-date').value;
            const customer = document.getElementById('cash-customer').value;
            const product = document.getElementById('cash-product').value;
            const amount = parseInt(document.getElementById('cash-amount').value) || 0;
            const route = document.getElementById('cash-route').value;
            const memo = document.getElementById('cash-memo').value;
            
            if (!date || !product || !amount || !route) {
                showNotification('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            cashSales.unshift({
                id: Date.now(),
                date: date,
                customer: customer,
                product: product,
                amount: amount,
                route: route,
                memo: memo
            });
            
            saveData();
            updateTables();
            updateSummaries();
            clearCashForm();
            showNotification('í˜„ê¸ˆë§¤ì¶œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ì‚¬ì—…ìë§¤ì¶œ ì¶”ê°€
        function addBusinessSale() {
            const date = document.getElementById('business-date').value;
            const client = document.getElementById('business-client').value;
            const product = document.getElementById('business-product').value;
            const amount = parseInt(document.getElementById('business-amount').value) || 0;
            const tax = parseInt(document.getElementById('business-tax').value) || 0;
            const memo = document.getElementById('business-memo').value;
            
            if (!date || !client || !product || !amount) {
                showNotification('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            businessSales.unshift({
                id: Date.now(),
                date: date,
                client: client,
                product: product,
                amount: amount,
                tax: tax,
                supplyAmount: amount - tax,
                memo: memo
            });
            
            saveData();
            updateTables();
            updateSummaries();
            clearBusinessForm();
            showNotification('ì‚¬ì—…ìë§¤ì¶œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ì§€ì¶œ ì¶”ê°€
        function addExpense() {
            const date = document.getElementById('expense-date').value;
            const vendor = document.getElementById('expense-vendor').value;
            const category = document.getElementById('expense-category').value;
            const amount = parseInt(document.getElementById('expense-amount').value) || 0;
            const memo = document.getElementById('expense-memo').value;
            
            if (!date || !vendor || !category || !amount) {
                showNotification('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            expenses.unshift({
                id: Date.now(),
                date: date,
                vendor: vendor,
                category: category,
                amount: amount,
                memo: memo
            });
            
            saveData();
            updateTables();
            updateSummaries();
            clearExpenseForm();
            showNotification('ì§€ì¶œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ê±°ë˜ì²˜ ì¶”ê°€
        function addClient() {
            const name = document.getElementById('client-name').value;
            const businessNumber = document.getElementById('client-business-number').value;
            const contact = document.getElementById('client-contact').value;
            const address = document.getElementById('client-address').value;
            const memo = document.getElementById('client-memo').value;
            
            if (!name) {
                showNotification('ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            clients.unshift({
                id: Date.now(),
                name: name,
                businessNumber: businessNumber,
                contact: contact,
                address: address,
                memo: memo
            });
            
            saveData();
            updateTables();
            clearClientForm();
            showNotification('ê±°ë˜ì²˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // í¼ ì´ˆê¸°í™”
        function clearCashForm() {
            document.getElementById('cash-customer').value = '';
            document.getElementById('cash-product').value = '';
            document.getElementById('cash-amount').value = '';
            document.getElementById('cash-route').value = '';
            document.getElementById('cash-memo').value = '';
        }

        function clearBusinessForm() {
            document.getElementById('business-client').value = '';
            document.getElementById('business-product').value = '';
            document.getElementById('business-amount').value = '';
            document.getElementById('business-tax').value = '';
            document.getElementById('business-memo').value = '';
        }

        function clearExpenseForm() {
            document.getElementById('expense-vendor').value = '';
            document.getElementById('expense-category').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-memo').value = '';
        }

        function clearClientForm() {
            document.getElementById('client-name').value = '';
            document.getElementById('client-business-number').value = '';
            document.getElementById('client-contact').value = '';
            document.getElementById('client-address').value = '';
            document.getElementById('client-memo').value = '';
        }

        // ì‚­ì œ ê¸°ëŠ¥ (ì°¨íŠ¸ ê°•ì œ ì—…ë°ì´íŠ¸ í¬í•¨)
        function deleteItem(type, index) {
            console.log('ì‚­ì œ ì‹œë„:', type, index);
            
            try {
                let message = '';
                console.log('ì‚­ì œ ì „ ë°°ì—´ ê¸¸ì´:', 
                    type === 'cash' ? cashSales.length : 
                    type === 'business' ? businessSales.length :
                    type === 'expense' ? expenses.length :
                    clients.length
                );
                
                switch(type) {
                    case 'cash':
                        cashSales.splice(index, 1);
                        message = 'í˜„ê¸ˆë§¤ì¶œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
                        break;
                    case 'business':
                        businessSales.splice(index, 1);
                        message = 'ì‚¬ì—…ìë§¤ì¶œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
                        // ì‚¬ì—…ìë§¤ì¶œ ì‚­ì œ ì‹œ ë¶€ê°€ì„¸ ì°¨íŠ¸ ê°•ì œ ì—…ë°ì´íŠ¸
                        setTimeout(() => {
                            drawMonthlyTaxChart();
                        }, 50);
                        break;
                    case 'expense':
                        expenses.splice(index, 1);
                        message = 'ì§€ì¶œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
                        break;
                    case 'client':
                        clients.splice(index, 1);
                        message = 'ê±°ë˜ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
                        break;
                }
                
                console.log('ì‚­ì œ í›„ ë°°ì—´ ê¸¸ì´:', 
                    type === 'cash' ? cashSales.length : 
                    type === 'business' ? businessSales.length :
                    type === 'expense' ? expenses.length :
                    clients.length
                );
                
                saveData();
                updateTables();
                updateSummaries();
                
                // ëª¨ë“  ì°¨íŠ¸ ê°•ì œ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    drawSalesExpenseChart();
                    drawMonthlyComparisonChart();
                    drawMonthlyTaxChart();
                }, 100);
                
                showNotification(message, 'success');
                
            } catch (error) {
                console.error('ì‚­ì œ ì—ëŸ¬:', error);
                showNotification('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateTables() {
            // í˜„ê¸ˆë§¤ì¶œ í…Œì´ë¸”
            const cashTbody = document.getElementById('cash-table');
            if (cashSales.length === 0) {
                cashTbody.innerHTML = '<tr><td colspan="7" class="empty-state">ë“±ë¡ëœ í˜„ê¸ˆë§¤ì¶œì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                let html = '';
                cashSales.forEach((sale, index) => {
                    html += `<tr>
                        <td>${sale.date}</td>
                        <td>${sale.customer || '-'}</td>
                        <td>${sale.product}</td>
                        <td>â‚©${sale.amount.toLocaleString()}</td>
                        <td>${sale.route}</td>
                        <td>${sale.memo || '-'}</td>
                        <td><button class="delete-btn" onclick="deleteItem('cash', ${index})">ì‚­ì œ</button></td>
                    </tr>`;
                });
                cashTbody.innerHTML = html;
            }
            
            // ì‚¬ì—…ìë§¤ì¶œ í…Œì´ë¸”
            const businessTbody = document.getElementById('business-table');
            if (businessSales.length === 0) {
                businessTbody.innerHTML = '<tr><td colspan="8" class="empty-state">ë“±ë¡ëœ ì‚¬ì—…ìë§¤ì¶œì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                let html = '';
                businessSales.forEach((sale, index) => {
                    html += `<tr>
                        <td>${sale.date}</td>
                        <td>${sale.client}</td>
                        <td>${sale.product}</td>
                        <td>â‚©${sale.supplyAmount.toLocaleString()}</td>
                        <td>â‚©${sale.tax.toLocaleString()}</td>
                        <td>â‚©${sale.amount.toLocaleString()}</td>
                        <td>${sale.memo || '-'}</td>
                        <td><button class="delete-btn" onclick="deleteItem('business', ${index})">ì‚­ì œ</button></td>
                    </tr>`;
                });
                businessTbody.innerHTML = html;
            }

            // ì§€ì¶œ í…Œì´ë¸”
            const expenseTbody = document.getElementById('expense-table');
            if (expenses.length === 0) {
                expenseTbody.innerHTML = '<tr><td colspan="6" class="empty-state">ë“±ë¡ëœ ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                let html = '';
                expenses.forEach((expense, index) => {
                    html += `<tr>
                        <td>${expense.date}</td>
                        <td>${expense.vendor}</td>
                        <td>${expense.category}</td>
                        <td>â‚©${expense.amount.toLocaleString()}</td>
                        <td>${expense.memo || '-'}</td>
                        <td><button class="delete-btn" onclick="deleteItem('expense', ${index})">ì‚­ì œ</button></td>
                    </tr>`;
                });
                expenseTbody.innerHTML = html;
            }

            // ê±°ë˜ì²˜ í…Œì´ë¸”
            const clientTbody = document.getElementById('client-table');
            if (clients.length === 0) {
                clientTbody.innerHTML = '<tr><td colspan="6" class="empty-state">ë“±ë¡ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                let html = '';
                clients.forEach((client, index) => {
                    html += `<tr>
                        <td>${client.name}</td>
                        <td>${client.businessNumber || '-'}</td>
                        <td>${client.contact || '-'}</td>
                        <td>${client.address || '-'}</td>
                        <td>${client.memo || '-'}</td>
                        <td><button class="delete-btn" onclick="deleteItem('client', ${index})">ì‚­ì œ</button></td>
                    </tr>`;
                });
                clientTbody.innerHTML = html;
            }
        }

        // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸ (ì°¨íŠ¸ ê°±ì‹  í¬í•¨)
        function updateSummaries() {
            const cashTotal = cashSales.reduce((sum, sale) => sum + sale.amount, 0);
            const businessTotal = businessSales.reduce((sum, sale) => sum + sale.amount, 0);
            const expenseTotal = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalSales = cashTotal + businessTotal;
            const netProfit = totalSales - expenseTotal;
            
            document.getElementById('cash-total').textContent = 'â‚©' + cashTotal.toLocaleString();
            document.getElementById('cash-count').textContent = cashSales.length + 'ê±´';
            document.getElementById('business-total').textContent = 'â‚©' + businessTotal.toLocaleString();
            document.getElementById('business-count').textContent = businessSales.length + 'ê±´';
            document.getElementById('expense-total').textContent = 'â‚©' + expenseTotal.toLocaleString();
            document.getElementById('expense-count').textContent = expenses.length + 'ê±´';
            document.getElementById('total-sales').textContent = 'â‚©' + totalSales.toLocaleString();
            document.getElementById('total-expenses').textContent = 'â‚©' + expenseTotal.toLocaleString();
            document.getElementById('net-profit').textContent = 'â‚©' + netProfit.toLocaleString();
            document.getElementById('total-count').textContent = (cashSales.length + businessSales.length) + 'ê±´';
            
            // ë§¤ì¶œ ë£¨íŠ¸ë³„ í†µê³„
            const routeStats = {};
            cashSales.forEach(sale => {
                routeStats[sale.route] = (routeStats[sale.route] || 0) + sale.amount;
            });
            
            let routeHtml = '';
            if (Object.keys(routeStats).length === 0) {
                routeHtml = '<div style="text-align: center; color: #6c757d;">ë°ì´í„° ì—†ìŒ</div>';
            } else {
                Object.entries(routeStats).forEach(([route, amount]) => {
                    routeHtml += '<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef;"><span>' + route + '</span><span style="font-weight: 600;">â‚©' + amount.toLocaleString() + '</span></div>';
                });
            }
            document.getElementById('route-stats').innerHTML = routeHtml;

            // ì§€ì¶œ í•­ëª©ë³„ í†µê³„
            const expenseStats = {};
            expenses.forEach(expense => {
                expenseStats[expense.category] = (expenseStats[expense.category] || 0) + expense.amount;
            });
            
            let expenseHtml = '';
            if (Object.keys(expenseStats).length === 0) {
                expenseHtml = '<div style="text-align: center; color: #6c757d;">ë°ì´í„° ì—†ìŒ</div>';
            } else {
                Object.entries(expenseStats).forEach(([category, amount]) => {
                    expenseHtml += '<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef;"><span>' + category + '</span><span style="font-weight: 600;">â‚©' + amount.toLocaleString() + '</span></div>';
                });
            }
            document.getElementById('expense-stats').innerHTML = expenseHtml;
            
            // í†µê³„ í™”ë©´ì´ í™œì„±í™”ëœ ê²½ìš° ì°¨íŠ¸ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            const statsScreen = document.getElementById('stats-screen');
            if (statsScreen && statsScreen.classList.contains('active')) {
                setTimeout(() => {
                    drawSalesExpenseChart();
                    drawMonthlyComparisonChart();
                    drawMonthlyTaxChart();
                }, 10);
            }
        }

        // ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ë“¤
        function drawSalesExpenseChart() {
            const canvas = document.getElementById('sales-expense-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 120;
            
            const cashTotal = cashSales.reduce((sum, sale) => sum + sale.amount, 0);
            const businessTotal = businessSales.reduce((sum, sale) => sum + sale.amount, 0);
            const totalSales = cashTotal + businessTotal;
            const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            const total = totalSales + totalExpenses;
            
            if (total === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ë°ì´í„° ì—†ìŒ', centerX, centerY);
                return;
            }
            
            const salesAngle = (totalSales / total) * 2 * Math.PI;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ë§¤ì¶œ (íŒŒë€ìƒ‰)
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, salesAngle);
            ctx.lineTo(centerX, centerY);
            ctx.fillStyle = '#3498db';
            ctx.fill();
            
            // ì§€ì¶œ (ë¹¨ê°„ìƒ‰)
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, salesAngle, 2 * Math.PI);
            ctx.lineTo(centerX, centerY);
            ctx.fillStyle = '#e74c3c';
            ctx.fill();
            
            // ë²”ë¡€
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            
            // ë§¤ì¶œ ë²”ë¡€
            ctx.fillStyle = '#3498db';
            ctx.fillRect(20, 20, 15, 15);
            ctx.fillStyle = '#333';
            ctx.fillText('ë§¤ì¶œ: â‚©' + totalSales.toLocaleString(), 40, 32);
            
            // ì§€ì¶œ ë²”ë¡€
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(20, 45, 15, 15);
            ctx.fillStyle = '#333';
            ctx.fillText('ì§€ì¶œ: â‚©' + totalExpenses.toLocaleString(), 40, 57);
        }

        function drawMonthlyComparisonChart() {
            const canvas = document.getElementById('monthly-comparison-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // ì´ë²ˆë‹¬ê³¼ ì €ë²ˆë‹¬ ë°ì´í„° ê³„ì‚°
            const thisMonthSales = cashSales.concat(businessSales).filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            }).reduce((sum, sale) => sum + sale.amount, 0);
            
            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            }).reduce((sum, expense) => sum + expense.amount, 0);
            
            let lastMonth = currentMonth - 1;
            let lastYear = currentYear;
            if (lastMonth < 0) {
                lastMonth = 11;
                lastYear = currentYear - 1;
            }
            
            const lastMonthSales = cashSales.concat(businessSales).filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === lastMonth && saleDate.getFullYear() === lastYear;
            }).reduce((sum, sale) => sum + sale.amount, 0);
            
            const lastMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === lastMonth && expenseDate.getFullYear() === lastYear;
            }).reduce((sum, expense) => sum + expense.amount, 0);
            
            const maxValue = Math.max(thisMonthSales, thisMonthExpenses, lastMonthSales, lastMonthExpenses);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (maxValue === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ë°ì´í„° ì—†ìŒ', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const barWidth = 60;
            const barSpacing = 80;
            const chartHeight = 120;
            const startX = 50;
            const startY = canvas.height - 50;
            
            // ì €ë²ˆë‹¬ ë§¤ì¶œ
            const lastSalesHeight = (lastMonthSales / maxValue) * chartHeight;
            ctx.fillStyle = '#95a5a6';
            ctx.fillRect(startX, startY - lastSalesHeight, barWidth, lastSalesHeight);
            
            // ì €ë²ˆë‹¬ ì§€ì¶œ
            const lastExpenseHeight = (lastMonthExpenses / maxValue) * chartHeight;
            ctx.fillStyle = '#bdc3c7';
            ctx.fillRect(startX + barSpacing, startY - lastExpenseHeight, barWidth, lastExpenseHeight);
            
            // ì´ë²ˆë‹¬ ë§¤ì¶œ
            const thisSalesHeight = (thisMonthSales / maxValue) * chartHeight;
            ctx.fillStyle = '#3498db';
            ctx.fillRect(startX + barSpacing * 2, startY - thisSalesHeight, barWidth, thisSalesHeight);
            
            // ì´ë²ˆë‹¬ ì§€ì¶œ
            const thisExpenseHeight = (thisMonthExpenses / maxValue) * chartHeight;
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(startX + barSpacing * 3, startY - thisExpenseHeight, barWidth, thisExpenseHeight);
            
            // ë¼ë²¨
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            ctx.fillText('ì „ë‹¬ë§¤ì¶œ', startX + barWidth/2, startY + 15);
            ctx.fillText('ì „ë‹¬ì§€ì¶œ', startX + barSpacing + barWidth/2, startY + 15);
            ctx.fillText('ì´ë‹¬ë§¤ì¶œ', startX + barSpacing * 2 + barWidth/2, startY + 15);
            ctx.fillText('ì´ë‹¬ì§€ì¶œ', startX + barSpacing * 3 + barWidth/2, startY + 15);
            
            // ê¸ˆì•¡ í‘œì‹œ (ë§‰ëŒ€ ìœ„ì—)
            ctx.font = '10px Arial';
            ctx.fillStyle = '#333';
            
            // ì „ë‹¬ ë§¤ì¶œ ê¸ˆì•¡
            if (lastMonthSales > 0) {
                ctx.fillText('â‚©' + lastMonthSales.toLocaleString(), startX + barWidth/2, startY - lastSalesHeight - 5);
            }
            
            // ì „ë‹¬ ì§€ì¶œ ê¸ˆì•¡
            if (lastMonthExpenses > 0) {
                ctx.fillText('â‚©' + lastMonthExpenses.toLocaleString(), startX + barSpacing + barWidth/2, startY - lastExpenseHeight - 5);
            }
            
            // ì´ë‹¬ ë§¤ì¶œ ê¸ˆì•¡
            if (thisMonthSales > 0) {
                ctx.fillText('â‚©' + thisMonthSales.toLocaleString(), startX + barSpacing * 2 + barWidth/2, startY - thisSalesHeight - 5);
            }
            
            // ì´ë‹¬ ì§€ì¶œ ê¸ˆì•¡
            if (thisMonthExpenses > 0) {
                ctx.fillText('â‚©' + thisMonthExpenses.toLocaleString(), startX + barSpacing * 3 + barWidth/2, startY - thisExpenseHeight - 5);
            }
        }

        function drawMonthlyTaxChart() {
            const canvas = document.getElementById('monthly-tax-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const currentYear = new Date().getFullYear();
            
            console.log('ë¶€ê°€ì„¸ ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì‹œì‘');
            console.log('í˜„ì¬ ì‚¬ì—…ìë§¤ì¶œ ë°ì´í„°:', businessSales);
            
            // ì›”ë³„ ë¶€ê°€ì„¸ ê³„ì‚° - ì™„ì „íˆ ìƒˆë¡œ ê³„ì‚°
            const monthlyTax = new Array(12).fill(0);
            
            // í˜„ì¬ ì¡´ì¬í•˜ëŠ” ì‚¬ì—…ìë§¤ì¶œë§Œ ê³„ì‚°
            businessSales.forEach((sale, index) => {
                console.log(`ì‚¬ì—…ìë§¤ì¶œ ${index}:`, sale);
                const saleDate = new Date(sale.date);
                if (saleDate.getFullYear() === currentYear) {
                    const month = saleDate.getMonth();
                    const tax = sale.tax || 0;
                    monthlyTax[month] += tax;
                    console.log(`${month + 1}ì›”ì— ë¶€ê°€ì„¸ ${tax} ì¶”ê°€, ì´í•©: ${monthlyTax[month]}`);
                }
            });
            
            console.log('ìµœì¢… ì›”ë³„ ë¶€ê°€ì„¸:', monthlyTax);
            
            const maxTax = Math.max(...monthlyTax);
            console.log('ìµœëŒ€ ë¶€ê°€ì„¸:', maxTax);
            
            // ìº”ë²„ìŠ¤ ì™„ì „íˆ ì§€ìš°ê¸°
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (maxTax === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ë¶€ê°€ì„¸ ë°ì´í„° ì—†ìŒ', canvas.width / 2, canvas.height / 2);
                
                // ìš”ì•½ë„ ì—…ë°ì´íŠ¸
                const summaryDiv = document.getElementById('monthly-tax-summary');
                if (summaryDiv) {
                    summaryDiv.innerHTML = `
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <strong>${currentYear}ë…„ ì´ ë¶€ê°€ì„¸: â‚©0</strong>
                        </div>
                    `;
                }
                return;
            }
            
            const barWidth = 25;
            const barSpacing = 30;
            const chartHeight = 120;
            const startX = 30;
            const startY = canvas.height - 40;
            
            monthlyTax.forEach((tax, index) => {
                const barHeight = (tax / maxTax) * chartHeight;
                const x = startX + index * barSpacing;
                
                ctx.fillStyle = tax > 0 ? '#27ae60' : '#bdc3c7';
                ctx.fillRect(x, startY - barHeight, barWidth, barHeight);
                
                // ì›” ë¼ë²¨
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText((index + 1) + 'ì›”', x + barWidth/2, startY + 15);
                
                // ê¸ˆì•¡ í‘œì‹œ (0ì´ ì•„ë‹Œ ê²½ìš°ë§Œ)
                if (tax > 0) {
                    ctx.font = '8px Arial';
                    ctx.fillText('â‚©' + tax.toLocaleString(), x + barWidth/2, startY - barHeight - 5);
                }
            });
            
            // ì—°ê°„ ì´ ë¶€ê°€ì„¸ ê³„ì‚° ë° í‘œì‹œ
            const totalYearlyTax = monthlyTax.reduce((sum, tax) => sum + tax, 0);
            console.log('ì—°ê°„ ì´ ë¶€ê°€ì„¸:', totalYearlyTax);
            
            const summaryDiv = document.getElementById('monthly-tax-summary');
            if (summaryDiv) {
                summaryDiv.innerHTML = `
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <strong>${currentYear}ë…„ ì´ ë¶€ê°€ì„¸: â‚©${totalYearlyTax.toLocaleString()}</strong>
                    </div>
                `;
            }
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            
            // í˜„ê¸ˆë§¤ì¶œ ì‹œíŠ¸
            const cashData = [
                ['ë‚ ì§œ', 'ê³ ê°ëª…', 'ìƒí’ˆ/ì„œë¹„ìŠ¤', 'ê¸ˆì•¡', 'ë§¤ì¶œë£¨íŠ¸', 'ë¹„ê³ ']
            ];
            cashSales.forEach(sale => {
                cashData.push([sale.date, sale.customer || '', sale.product, sale.amount, sale.route, sale.memo || '']);
            });
            const cashWs = XLSX.utils.aoa_to_sheet(cashData);
            XLSX.utils.book_append_sheet(wb, cashWs, 'í˜„ê¸ˆë§¤ì¶œ');
            
            // ì‚¬ì—…ìë§¤ì¶œ ì‹œíŠ¸
            const businessData = [
                ['ë‚ ì§œ', 'ê±°ë˜ì²˜ëª…', 'ìƒí’ˆ/ì„œë¹„ìŠ¤', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸', 'ì´ê¸ˆì•¡', 'ë¹„ê³ ']
            ];
            businessSales.forEach(sale => {
                businessData.push([sale.date, sale.client, sale.product, sale.supplyAmount, sale.tax, sale.amount, sale.memo || '']);
            });
            const businessWs = XLSX.utils.aoa_to_sheet(businessData);
            XLSX.utils.book_append_sheet(wb, businessWs, 'ì‚¬ì—…ìë§¤ì¶œ');
            
            // ì§€ì¶œ ì‹œíŠ¸
            const expenseData = [
                ['ë‚ ì§œ', 'ì§€ì¶œì²˜', 'í•­ëª©', 'ê¸ˆì•¡', 'ë¹„ê³ ']
            ];
            expenses.forEach(expense => {
                expenseData.push([expense.date, expense.vendor, expense.category, expense.amount, expense.memo || '']);
            });
            const expenseWs = XLSX.utils.aoa_to_sheet(expenseData);
            XLSX.utils.book_append_sheet(wb, expenseWs, 'ì§€ì¶œ');
            
            // ê±°ë˜ì²˜ ì‹œíŠ¸
            const clientData = [
                ['ê±°ë˜ì²˜ëª…', 'ì‚¬ì—…ìë²ˆí˜¸', 'ì—°ë½ì²˜', 'ì£¼ì†Œ', 'ë¹„ê³ ']
            ];
            clients.forEach(client => {
                clientData.push([client.name, client.businessNumber || '', client.contact || '', client.address || '', client.memo || '']);
            });
            const clientWs = XLSX.utils.aoa_to_sheet(clientData);
            XLSX.utils.book_append_sheet(wb, clientWs, 'ê±°ë˜ì²˜');
            
            // ìš”ì•½ ì‹œíŠ¸
            const cashTotal = cashSales.reduce((sum, sale) => sum + sale.amount, 0);
            const businessTotal = businessSales.reduce((sum, sale) => sum + sale.amount, 0);
            const expenseTotal = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalSales = cashTotal + businessTotal;
            const netProfit = totalSales - expenseTotal;
            
            const summaryData = [
                ['ë§¤ì¶œ ìš”ì•½'],
                ['êµ¬ë¶„', 'ê¸ˆì•¡', 'ê±´ìˆ˜'],
                ['í˜„ê¸ˆë§¤ì¶œ', cashTotal, cashSales.length],
                ['ì‚¬ì—…ìë§¤ì¶œ', businessTotal, businessSales.length],
                ['ì´ ë§¤ì¶œ', totalSales, cashSales.length + businessSales.length],
                ['ì´ ì§€ì¶œ', expenseTotal, expenses.length],
                ['ìˆœì´ìµ', netProfit, '']
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'ìš”ì•½');
            
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, 'ë§¤ì¶œê´€ë¦¬_' + currentUser + '_' + today + '.xlsx');
            showNotification('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ì—”í„°í‚¤ë¡œ ë¡œê·¸ì¸
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') {
                doLogin();
            }
        });
    </script>
</body>
</html>
